<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
</head>

<body>
    <!--添加app的模态框-->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">添加app</h4>
                </div>
                <div class="modal-body text-center">
                    <form class="text-center form-inline" id="addForm">
                        <p>
                            <img src="images/app/1.png" alt="" width="100px">
                        </p>
                        <p>
                            app名称:<input type="text" name="appName" placeholder="请输入app名称" class="form-control"
                                style="width: 260px">
                        </p>
                        <p>
                            app类型:
                            <select name="appType" class="form-control" style="width: 260px">
                                <option value="">请选择类型</option>
                                <option value="娱乐">娱乐</option>
                                <option value="办公">办公</option>
                                <option value="休闲">休闲</option>
                                <option value="教育">教育</option>
                            </select>
                        </p>

                        <p>
                            app平台:
                            <select name="appPlatform" class="form-control" style="width: 260px">
                                <option value="">请选择平台</option>
                                <option value="魔方云">魔方云</option>
                                <option value="云表">云表</option>
                                <option value="软件云">软件云</option>
                                <option value="狐表">狐表</option>
                            </select>
                        </p>
                        <p>
                            app大小:<input type="text" name="appSize" placeholder="请输入软件大小" class="form-control"
                                style="width: 260px">
                        </p>
                        <p>
                            app图片:<input type="text" name="appImg" style="width: 200px" readonly placeholder="请上传图片"
                                class="form-control">
                            <button type="button" class="btn btn-default" id="addImgBtn">上传</button>
                        </p>
                        <p>
                            <button type="button" class="btn btn-primary" id="addBtn">添加</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!--修改app的模态框-->
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">修改app</h4>
                </div>
                <div class="modal-body text-center">
                    <form class="text-center form-inline" id="updateForm">
                        <p>
                            <input type="hidden" name="index">
                        </p>
                        <p>
                            <img src="images/app/1.png" alt="" width="100px">
                        </p>
                        <p>
                            app编号:<input type="text" name="id" readonly class="form-control" style="width: 260px">
                        </p>
                        <p>
                            app名称:<input type="text" name="appName" placeholder="请输入app名称" class="form-control"
                                style="width: 260px">
                        </p>
                        <p>
                            app类型:
                            <select name="appType" class="form-control" style="width: 260px">
                                <option value="">请选择类型</option>
                                <option value="娱乐">娱乐</option>
                                <option value="办公">办公</option>
                                <option value="休闲">休闲</option>
                                <option value="教育">教育</option>
                            </select>
                        </p>

                        <p>
                            app平台:
                            <select name="appPlatform" class="form-control" style="width: 260px">
                                <option value="">请选择平台</option>
                                <option value="魔方云">魔方云</option>
                                <option value="云表">云表</option>
                                <option value="软件云">软件云</option>
                                <option value="狐表">狐表</option>
                            </select>
                        </p>
                        <p>
                            app大小:<input type="text" name="appSize" placeholder="请输入软件大小" class="form-control"
                                style="width: 260px">
                        </p>
                        <p>
                            app次数:<input type="text" readonly name="appCount" placeholder="下载次数" class="form-control"
                                style="width: 260px">
                        </p>
                        <p>
                            app图片:<input type="text" name="appImg" style="width: 200px" readonly placeholder="请上传图片"
                                class="form-control">
                            <button type="button" class="btn btn-default" id="updateUpImgBtn">上传</button>
                        </p>
                        <p>
                            <button type="button" class="btn btn-primary" id="updateAppBtn">修改</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <h1 class="text-center">app后台管理</h1>
    <div class="container">
        <div class="row table-bordered" style="line-height: 100px">
            <div class="col-md-8">
                <form class="form-inline">
                    app名称:
                    <input type="text" name="appName" placeholder="请输入app名称" class="form-control">
                    　　app类型:
                    <select id="appType" name="appType" class="form-control">
                        <option value="">请选择类型</option>
                        <option value="娱乐">娱乐</option>
                        <option value="办公">办公</option>
                        <option value="休闲">休闲</option>
                        <option value="教育">教育</option>
                    </select>
                    　　app平台:
                    <select id="appPlatform" name="app" class="form-control">
                        <option value="">请选择平台</option>
                        <option value="魔方云">魔方云</option>
                        <option value="云表">云表</option>
                        <option value="软件云">软件云</option>
                        <option value="狐表">狐表</option>
                    </select>
                </form>
            </div>
            <div class="col-md-4 text-right">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addModal"><span
                        class="glyphicon glyphicon-plus"></span> 添加</button>
                <button type="button" class="btn btn-warning"><span class="glyphicon glyphicon-remove"></span>
                    批量删除</button>
            </div>
        </div>

        <div class="row">
            <table class="col-md-12 table-bordered text-center" style="margin-top: 30px">
                <tr style="line-height: 60px;background: gray;color: white">
                    <td>全选/全消 <input type="checkbox" id="allId"></td>
                    <td>编号</td>
                    <td>名称</td>
                    <td>软件大小</td>
                    <td>软件类型</td>
                    <td>软件平台</td>
                    <td>下载次数</td>
                    <td>图片</td>
                    <td colspan="2">操作</td>
                </tr>
                <tbody id="showTab">
                    <tr>
                        <td>选择 <input type="checkbox" class="sel"></td>
                        <td>1</td>
                        <td>王者荣耀</td>
                        <td>2000M</td>
                        <td>娱乐</td>
                        <td>软件云</td>
                        <td>100万次</td>
                        <td><img src="images/app/1.png" width="40px"></td>
                        <td><button type="button" class="btn btn-danger"><span
                                    class="glyphicon glyphicon-remove"></span> 删除</button></td>
                        <td><button type="button" data-toggle="modal" data-target="#updateModal"
                                class="btn btn-primary"><span class="glyphicon glyphicon-edit"></span> 修改</button></td>
                    </tr>

                </tbody>
            </table>
        </div>

    </div>
    <script type="text/javascript" src="js/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script src="./js/axios.js"></script>
    <script type="text/javascript">
        function queryApp(params) {
            axios("/app/queryApp").then((res) => {
                let str = ``;
                let appArr = res;
                for (let i = 0; i < appArr.length; i++) {
                    str += `<tr>
                        <td>选择 <input type="checkbox" class="sel" value="${appArr[i]._id}"></td>
                        <td>${appArr[i]._id}</td>
                        <td>${appArr[i].appName}</td>
                        <td>${appArr[i].appSize}</td>
                        <td>${appTypeMap.get(appArr[i].appTypeId)}</td>
                        <td>${appPlatformMap.get(appArr[i].appPlatformId)}</td>
                        <td>${appArr[i].appDownLoadCount}万次</td>
                        <td><img src="${appArr[i].appImg}" width="40px"></td>
                        <td><button type="button" class="btn btn-danger" onclick="deleteApp(${i})"><span class="glyphicon glyphicon-remove"></span> 删除</button></td>
                        <td><button type="button" data-toggle="modal" onclick="showApp(${i})" data-target="#updateModal" class="btn btn-primary"><span class="glyphicon glyphicon-edit"></span> 修改</button></td>
                    </tr>`;
                }
                $("#showTab").html(str);
            })
        }

        let appTypeMap = new Map();
        function queryAppType(params) {
            axios("/app/queryAppType").then((res) => {
                let str = ``;
                res.forEach(element => {
                    str += `<option value="${element._id[0]._id}">${element._id[0].type}</option>`
                    appTypeMap.set(element._id[0]._id, element._id[0].type);
                });
                $("#appType").html(str);
            });

        }

        let appPlatformMap = new Map();
        function queryAppPlatform(params) {
            axios("/app/queryAppPlatform").then((res) => {
                let str = ``;
                res.forEach(element => {
                    str += `<option value="${element._id[0]._id}">${element._id[0].platform}</option>`
                    appPlatformMap.set(element._id[0]._id, element._id[0].platform);
                });
                $("#appPlatform").html(str);
            });

        }
        queryAppType();
        queryAppPlatform();
        queryApp();


        //1.删除app
        function deleteApp(index) {
            appArr.splice(index, 1);//从内存删除数据
            localStorage.setItem("appList", JSON.stringify(appArr));//更新缓存中的数据
            alert("删除成功");
            queryApp();//重新回显数据
        }

        //2.点击添加完成添加任务
        let idStr = localStorage.getItem("idCount");
        let idCount = 11;
        if (idStr != null) {
            idCount = parseInt(idStr);
        } else {
            localStorage.setItem("idCount", idCount);
        }
        $("#addBtn").bind("click", function () {
            let app = {
                id: idCount++,
                appName: "",
                appType: "",
                appPlatform: "",
                appCount: 0,
                appSize: 0,
                appImg: ""
            };

            app.appName = $("#addForm [name=appName]").val();
            app.appType = $("#addForm [name=appType]").val();
            app.appPlatform = $("#addForm [name=appPlatform]").val();
            app.appSize = $("#addForm [name=appSize]").val();
            app.appImg = $("#addForm [name=appImg]").val();
            appArr.push(app);
            localStorage.setItem("appList", JSON.stringify(appArr));//刷新app数据缓存
            localStorage.setItem("idCount", idCount.toString());//刷新id的值
            queryApp();
            alert("添加成功...");
        });
        //点击添加app中的上传图片完成回显
        $("#addImgBtn").bind("click", function () {
            //[1,12)
            let appImg = `images/app/${parseInt(Math.random() * 11) + 1}.png`;
            $("#addForm [name=appImg]").val(appImg);
            $("#addForm img").attr("src", appImg);
        });

        //将app数据回显到 修改的表单中
        function showApp(index) {
            let app = appArr[index];
            $("#updateForm [name=id]").val(app.id);
            $("#updateForm [name=appName]").val(app.appName);
            $("#updateForm [name=appType]").val(app.appType);
            $("#updateForm [name=appPlatform]").val(app.appPlatform);
            $("#updateForm [name=appSize]").val(app.appSize);
            $("#updateForm [name=appImg]").val(app.appImg);
            $("#updateForm [name=appCount]").val(app.appCount);
            $("#updateForm img").attr("src", app.appImg);
            $("#updateForm [name=index]").val(index);
        }

        //点击模态框中的修改按钮，完成真正的修改功能
        $("#updateAppBtn").click(function () {
            let app = appArr[$("#updateForm [name=index]").val()];
            app.appName = $("#updateForm [name=appName]").val();
            app.appType = $("#updateForm [name=appType]").val();
            app.appPlatform = $("#updateForm [name=appPlatform]").val();
            app.appSize = $("#updateForm [name=appSize]").val();
            app.appImg = $("#updateForm [name=appImg]").val();
            //更新缓存数据
            localStorage.setItem("appList", JSON.stringify(appArr));
            alert("修改成功");
            queryApp();
        });
        //点击 修改按钮中 上传，修改图片
        $("#updateUpImgBtn").click(function () {
            //[1,12)
            let appImg = `images/app/${parseInt(Math.random() * 11) + 1}.png`;
            $("#updateForm [name=appImg]").val(appImg);
            $("#updateForm img").attr("src", appImg);
        });
    </script>
</body>

</html>
